"use strict";function WebSocketService(e){var t,n,o=e,i=50;this.connect=function(e,i){void 0!==t&&t.readyState!==WebSocket.CLOSED||(n="https:"===window.location.protocol?"wss://"+o+e:"ws://"+o+e,t=new WebSocket(n),a(function(){i(e)}))},this.disconnect=function(e){void 0!==t&&(t.readyState===WebSocket.OPEN&&t.close(),s(e))},this.status=function(){return t.readyState},this.setHandler=function(e){t.onmessage=e},this.send=function(e){a(function(){t.send(JSON.stringify(e))})};var r=function(){swal({title:"Network Error",text:"Please check your connection and reload page",type:"error",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Reload",cancelButtonText:"Stay"}).then(function(){window.location.reload()},function(e){})},a=function(e){i>=0?setTimeout(function(){return t.readyState===WebSocket.OPEN?void(null!=e&&e()):(console.log("Waiting connection.."),i--,a(e),void 0)},100):(i=50,r())},s=function(e){i>=0?setTimeout(function(){return t.readyState===WebSocket.CLOSED?void(null!=e&&e()):(console.log("Waiting disconnection.."),i--,a(e),void 0)},10):(i=50,r())}}function SearchService(){var e,t;e=$(".search-bar"),this.search=$("#search"),this.reset=$("#reset"),t=$("#results"),this.show=function(){e.show()},this.hide=function(){e.hide()};var n=function(){return $("#search").val()},o=function(e){$.ajax({type:"POST",url:"/messages",dataType:"text",data:"message="+n(),success:function(t){e(t)},error:function(e){console.log(e)}})},i=function(e){var n=JSON.parse(e);n.forEach(function(e){var n=$('<div class="collapsible-header ">'+e.name+"</div>"),o=$('<div class="collapsible-body"> <p>TODO</p> </div>'),i=$("<li></li>");i.append(n).append(o),t.append(i)})};this.showResults=function(){o(function(e){i(e),$(".collapsible").collapsible(),t.show()})},this.hideResults=function(){t.hide(),t.empty()}}function NavBarService(){var e=$("#loading");this.closeBtn=$("#close");var t=new SearchService;this.search=t.search,this.reset=t.reset,this.showLoad=function(){e.show()},this.hideLoad=function(){e.hide()},this.showClose=function(){this.closeBtn.show()},this.hideClose=function(){this.closeBtn.hide()},this.showSearch=function(){t.show()},this.hideSearch=function(){t.hide()},this.showResults=function(){t.showResults()},this.hideResults=function(){t.hideResults()}}function SideNavService(){var e,t;e=$("#slide-out"),t=$(".button-collapse"),this.rooms=$("#rooms");var n=function(){$(".side-nav li a").on("click",function(e){var n=$(window).width();n<992&&t.sideNav("hide")})},o=function(e){$("#rooms").empty(),e.forEach(function(e){$("#rooms").append('<a class="collection-item waves-effect">'+e.name+"</a>")})};this.init=function(e){t.sideNav({menuWidth:240,edge:"left",draggable:!0,closeOnClick:!1}),n(),o(e)},this.show=function(){e.show()},this.hide=function(){e.hide()}}function RoomService(){this.roomBtn=$("#add_room"),this.getRooms=function(e){$.ajax({type:"GET",url:"/rooms",success:function(t){e(t)},error:function(e){console.log(e)}})};var e=function(e,t,n,o){$.ajax({type:"POST",url:"/rooms",contentType:"application/json",dataType:"JSON",data:JSON.stringify({name:e,user:t,date:new Date}),success:function(e){n()},error:function(e){o("An error occured. Please retry later.")}})};this.createNewRoom=function(t,n){swal({title:"Enter a room name",input:"text",showCancelButton:!0,confirmButtonText:"OK",showLoaderOnConfirm:!0,preConfirm:function(n){return new Promise(function(o,i){$.trim(n)&&/^[a-zA-Z0-9-_.]+$/.test(n)?e(n,t,o,i):i("Please enter a valid room name.")})}}).then(function(e){swal({type:"success",title:"New room created :",html:e}),n()})}}function HomeService(){var e,t,n,o,i;e=$("#home"),o=$("#login-form"),t=$("#mail"),n=$("#epassword"),this.enterBtn=$("#enter"),this.registerBtn=$("#registerBtn"),this.show=function(){e.show()},this.hide=function(){e.hide()};var r=function(e){i=e.validate({rules:{mail:{required:!0,email:!0},epassword:{required:!0,minlength:10}},messages:{mail:{required:"An adress mail is required"},epassword:{required:"A password is required"}}})};this.validForm=function(){return o.valid()},this.getMail=function(){return t.val()},this.getPassword=function(){return n.val()},r(o)}function RegisterService(){var e,t,n,o,i,r;t=$("#register"),o=$("#register-form"),n=$("#rpassword"),r=$("#password-strength"),this.validBtn=$("#valid"),this.show=function(){t.show()},this.hide=function(){t.hide()};var a=function(){r.show()},s=function(){r.hide()},c=function(){var e,t=h(),n=r.find("div");if($.trim(t)){switch(a(),e=zxcvbn(t),e.score){case 0:$("#pstrength").text("Nonexistent");break;case 1:$("pstrength").text("Weak"),n.css("background-color","#f44336");break;case 2:$("#pstrength").text("Good"),n.css("background-color","#ff9800");break;case 3:$("#pstrength").text("Strong"),n.css("background-color","#ffeb3b");break;case 4:$("#pstrength").text("Insane"),n.css("background-color","#009688")}e=100*e.score/4,n.width(e+"%")}else s()};this.refreshPasswordStrength=function(){n.on("input",c)};var u=function(){var e=new Date;e.setFullYear(e.getFullYear()-10),$(".datepicker").pickadate({selectMonths:!0,selectYears:15,max:e})},l=function(e){i=e.validate({rules:{email:{required:!0,email:!0},rpassword:{required:!0,minlength:10,passwordCheck:!0},rconfirm:{required:!0,minlength:10,equalTo:"#rpassword"},username:{maxlength:30},birthdate:{date:!0},telephone:{phone:!0}},messages:{email:{required:"An adress mail is required"},rpassword:{required:"A password is required"},rconfirm:{required:"Confirm your password",equalTo:"Your passwords don't match"},birthdate:{date:"Enter a valid birthdate."}}})},d=function(){return $("#email").val()},h=function(){return n.val()},f=function(){return $("#username").val()},p=function(){return new Date($("#birthdate").val())},m=function(){var e,t=$("#male").prop("checked"),n=$("#female").prop("checked");return e=t||n?t?"M":"F":""},v=function(){return $("#telephone").val()},w=function(){var e={mail:d(),password:h(),username:f(),birthdate:p(),gender:m(),phone:v()};return e},g=function(t,n,o){e=w(),e.captcha=t,$.ajax({type:"POST",url:"/register",contentType:"application/json",dataType:"JSON",data:JSON.stringify(e),success:function(){n()},error:function(e){o()}})},S=function(){swal.disableConfirmButton(),$(".swal2-confirm").wrap(function(){return'<div class="col s12 m6 tooltipped" data-position="top" data-tooltip="Please verify the captcha"/>'}),$(".swal2-cancel").wrap(function(){return'<div class="col s12 m6"/>'}),$(".tooltipped").tooltip({delay:50})},b=function(){swal.enableConfirmButton(),$(".tooltipped").tooltip("remove")},y=function(){S();var e="6LcepBIUAAAAADFMYhb4fas-oTTeTBqjlX765lLG";grecaptcha.render("captcha",{sitekey:e,callback:b,theme:"dark"})},k=function(){var e=grecaptcha.getResponse();return 0!=e.length&&e},C=function(){return o.valid()};this.openCaptcha=function(e){C()&&swal({title:"Terms and Conditions",html:'<p>By creating an account, you consent to the <a href="">Terms of Service</a> and the <a href="">Privacy Policy</a>.</p><div id="captcha" class="row"/>',type:"info",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Agree",cancelButtonText:"Cancel",confirmButtonClass:"btn",cancelButtonClass:"btn",buttonsStyling:!1,onOpen:y,preConfirm:function(){return new Promise(function(e,t){var n=k();n?g(n,e,t):t("Please vefiry the captcha")})}}).then(function(){swal({title:"Success",text:"A confirmation mail has been send to your inbox.",type:"success"}).then(function(){e()})})},u(),l(o)}function ValidatorService(){$.validator.setDefaults({errorClass:"invalid",validClass:"valid",errorPlacement:function(e,t){$(t).closest("form").find("label[for='"+t.attr("id")+"']").attr("data-error",e.text())},submitHandler:function(e){}}),$.validator.methods.email=function(e,t){return this.optional(t)||/[A-Za-z.\d-]+@[a-z.\d-]+\.[a-z]/.test(e)},$.validator.addMethod("passwordCheck",function(e,t){return this.optional(t)||/^[A-Za-z0-9\d=!\-@._*]*$/.test(e)&&/[a-z]/.test(e)&&/\d/.test(e)},"Your password must contain at least one number."),$.validator.addMethod("dateGreaterThan",function(e,t,n){return/Invalid|NaN/.test(new Date(e))?isNaN(e)&&isNaN($(n).val())||Number(e)>Number($(n).val()):new Date(e)>new Date($(n).val())},"Must be greater than {0}."),$.validator.addMethod("phone",function(e,t){return this.optional(t)||/^[+?\d\s-]+$/.test(e)},"Enter a valid phone number.")}function SessionService(){var e=window.sessionStorage,t=function(){return e};this.setItem=function(t,n){return e.setItem(t,n)},this.getItem=function(t){return e.getItem(t)},this.removeItem=function(t){return e.removeItem(t)};var n=function(){return e.clear()},o=function(){Storage.prototype.setObject=function(e,t){this.setItem(e,JSON.stringify(t))},Storage.prototype.getObject=function(e){var t=this.getItem(e);return t&&JSON.parse(t)}};o();var i=function(t,n){return e.setObject(t,n)};this.getObject=function(t){return e.getObject(t)},this.storeObject=function(e,n){t()?i(e,n):r()},this.handleSession=function(e){t()?e():r()},this.clearSession=function(){t()?n():r()};var r=function(){Materialize.toast("Warning : your browser doesn't handle HTML5 !",5e3,"rounded")}}function ChatService(e){var t,n,o,i,r,a,s,c,u,l,d,h,f,p,m;p=!1,m=!1,a=$("#chat"),s=$("#conv"),c=$("#msg"),u=$("#bsend"),l=$("#msend"),d=$("#room-name"),h=$("#history"),f=-1,t=new Date,ValidatorService();var v=new RoomService,w=new NavBarService,g=new SideNavService,S=new HomeService,b=new RegisterService,y=new SessionService,k=new WebSocketService(e),C=function(){a.show(),g.show(),w.showSearch(),w.showClose()},B=function(){a.hide(),g.hide(),w.hideSearch(),w.hideClose()},O=function(){S.hide(),b.show(),w.showClose()},x=function(e){y.storeObject("user",e)},N=function(e){y.storeObject("room",e)},T=function(){k.setHandler(W),d.text(i),$("#name").text(o),$("#usermail").html(n+"<i class='material-icons right'>arrow_drop_down</i>"),S.hide(),w.hideLoad(),g.init(r),C(),m=!0},j=function(e){N(e),k.setHandler(W),T(),M()},P=function(){$("input:empty:visible:enabled:first").focus()},R=function(e){$.ajax({type:"POST",url:"/login",contentType:"application/json",dataType:"JSON",data:JSON.stringify(e),success:function(e){x(e),n=e.mail,o=$.trim(e.username)?e.username:e.mail.split("@")[0],k.connect(i,j)},error:function(e){console.log(e),w.hideLoad(),swal({title:"Authentication failed",text:e.responseText,type:"error",animation:!1,customClass:"animated shake",timer:3e3}).catch(swal.noop)}})},D=function(){if(!m)if(i="General",S.validForm()){var e={mail:S.getMail(),password:S.getPassword()};w.showLoad(),R(e)}else P()},q=function(e){var t,o,i,r=$('<li class="collection-item">'),a=e.sender;return e.mail===n?(o=$("<small>"+e.date+"</small>"),t=$('<strong class="right">'+a+"</strong>"),i=$('<p style="text-align: right">'+e.message+"</p>"),r.append(o).append(t).append(i)):(t=$("<strong>"+a+"</strong>"),o=$('<small class="right">'+e.date+"</small>"),i=$("<p>"+e.message+"</p>"),r.append(t).append(o).append(i)),r},A=function(e){s.append(q(e))},E=function(e){s.prepend(q(e))},W=function(e){e.preventDefault();var t=JSON.parse(e.data);t.mail==n&&l.hide(),A(t)},J=function(){if($.trim(c.val()))if(k.status()===WebSocket.OPEN){l.show();var e={message:c.val().replace(/(?:\r\n|\r|\n)/g,"<br/>"),sender:o,mail:n};k.send(e),c.val("").focus(),G()}else l.hide()},I=function(e,t){$.ajax({type:"GET",url:"/messages/"+i+"/"+e,success:function(e){t(e)},error:function(e){console.log(e)}})},L=function(){return f+=1},M=function(){I(L(),function(e){var n=e.content;n.forEach(function(e){var n=Date.parse(e.date);n<t&&E(e)}),s.prepend(h),e.last===!0?h.hide():h.show()})},H=function(){s.empty()},z=function(e){k.disconnect(function(){k.connect(e,function(){t=new Date,k.setHandler(W),H(),d.text(e),i=e,f=-1,M()})})},F=function(){m?k.disconnect(function(){y.clearSession(),B(),m=!1}):(w.hideClose(),b.hide()),S.show(),P()},G=function(){p||s.stop().animate({scrollTop:s[0].scrollHeight},1e3),s.hover(function(e){e.preventDefault(),p="mouseenter"==e.type,p||G()})};this.init=function(){$(".collapsible").collapsible();var e=$("body");v.getRooms(function(e){r=e}),S.enterBtn.click(D),S.registerBtn.click(O),e.on("keypress",function(e){if(13==e.which)return D(),!1}),c.on("keypress",function(e){if(13===e.which&&!e.shiftKey)return J(),!1}),u.click(J),b.refreshPasswordStrength(),b.validBtn.click(function(){b.openCaptcha(F)}),g.rooms.click(function(e){var t=$(e.target).text();$.trim(t)&&z(t)}),v.roomBtn.click(function(){v.createNewRoom(n,function(){v.getRooms(function(e){r=e,g.init(r)})})}),s.on("click",".history",function(){M()}),w.search.on("keypress",function(e){13===e.which&&(e.preventDefault(),w.showResults())}),w.reset.click(w.hideResults),w.closeBtn.click(F)}}$(window).on("load",function(){setTimeout(function(){$("body").addClass("loaded")},1e3)}),$(document).ready(function(){(function(){var e="./lib/particlesjs-config.json",t="localhost:8080/chat/",n=new ChatService(t);n.init();(function(){particlesJS.load("particles-js",e)})();swal.setDefaults({background:"#546e7a"})})()});